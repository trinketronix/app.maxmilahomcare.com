<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?=$pageTitle ?? 'Patient Management'?></title>

    <link rel="apple-touch-icon" sizes="180x180" href="../img/fav/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../img/fav/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../img/fav/favicon-16x16.png">
    <link rel="manifest" href="../site.webmanifest">
    <link rel="shortcut icon" href="../img/fav/favicon.ico">

    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <style>
        html, body { height: 100vh; overflow: hidden; background-color: #f0f2f5; font-family: 'Segoe UI', 'Roboto', sans-serif; }
        .page-container { display: flex; flex-direction: column; height: 100vh; max-width: 500px; margin: 0 auto; background-color: #ffffff; border-left: 1px solid #dcdcdc; border-right: 1px solid #dcdcdc; position: relative; }

        /* Header & Controls */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; position: relative; flex-shrink: 0; }
        .back-button { text-decoration: none; color: #333; font-weight: 500; }
        .header-title { font-size: 1.8rem; font-weight: bold; margin: 0; position: absolute; left: 50%; transform: translateX(-50%); }
        .header-subtitle { position: absolute; left: 50%; transform: translateX(-50%); top: 4.5rem; font-size: 1.5rem; color: #555; }
        .profile-icon { font-size: 1.5rem; border: 2px solid #000; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; margin: 0 auto; overflow: hidden; }
        .profile-icon img { width: 100%; height: 100%; object-fit: cover; }
        .profile-username { font-size: 0.8rem; color: #555; margin-top: 4px; }

        .controls-section { padding: 1rem; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; }
        .search-bar .form-control, .search-bar .btn { border-radius: 8px; border: 2px solid #000; }
        .filter-buttons { display: flex; overflow-x: auto; padding-top: 1rem; gap: 0.5rem; }
        .filter-buttons::-webkit-scrollbar { display: none; }
        .filter-btn { border: 2px solid #000; border-radius: 8px; background-color: #fff; color: #000; font-weight: 500; white-space: nowrap; }
        .filter-btn.active { background-color: #000; color: #fff; }

        /* Patient List */
        .patient-list-container { flex-grow: 1; overflow-y: auto; padding: 1rem; padding-bottom: 120px; }
        .patient-item { display: flex; align-items: center; gap: 1rem; border: 2px solid #000; border-radius: 15px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: background-color 0.2s; text-decoration: none; color: inherit; }
        .patient-item:hover { background-color: #f1f1f1; }
        .patient-avatar { width: 60px; height: 60px; min-width: 60px; border-radius: 50%; border: 3px solid #000; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .patient-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .patient-info { display: grid; grid-template-columns: 1fr auto; width: 100%; align-items: center; }
        .patient-name { font-weight: bold; font-size: 1.1rem; }
        .patient-phone { color: #555; }
        .patient-status { font-weight: bold; justify-self: end; }
        .status-active { color: #198754; } .status-inactive { color: #dc3545; }
        .status-not-verified { color: #fd7e14; } .status-archived { color: #6f42c1; } .status-deleted { color: #6c757d; }

        /* FAB & Offcanvas */
        .fab { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90px; height: 90px; border-radius: 50%; background-color: #e0e0e0; border: 3px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 500; text-decoration: none; color: #000; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1040; }
        .fab .plus-icon { font-size: 2rem; line-height: 1; }
        .fab .plus-text { font-size: 0.8em; }
        .offcanvas-header { border-bottom: 1px solid #dee2e6; }
        #resultModal .modal-footer { border-top: 0; }
        #resultModal .close-btn { background: #000; color: #fff; border-radius: 50%; width: 50px; height: 50px; border: 0; }
        #alert-container { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 480px; }
    </style>
</head>
<body>

<div id="alert-container"></div>

<div class="page-container">
    <header class="header">
        <a href="/dashboard/admin" class="back-button"><i class="fas fa-chevron-left"></i> Back</a>
        <h1 class="header-title">Management</h1>
        <h2 class="header-subtitle">Patients</h2>
        <div class="profile">
            <div class="profile-icon"><img src="<?=$photo?>" alt="avatar"></div>
            <span class="profile-username"><?=$fullname?></span>
        </div>
    </header>

    <section class="controls-section">
        <div class="input-group search-bar">
            <input type="text" id="search-input" class="form-control" placeholder="Search patient...">
            <button class="btn btn-dark" type="button" id="search-button">Search</button>
        </div>
        <div class="filter-buttons">
            <button class="btn filter-btn active" data-filter-status="all">All</button>
            <button class="btn filter-btn" data-filter-status="1">Active</button>
            <button class="btn filter-btn" data-filter-status="0">Inactive</button>
            <button class="btn filter-btn" data-filter-status="-1">Not Verified</button>
            <button class="btn filter-btn" data-filter-status="2">Archived</button>
            <button class="btn filter-btn" data-filter-status="3">Deleted</button>
        </div>
    </section>

    <main class="patient-list-container">
        <div id="patient-list"><div class="text-center p-5"><div class="spinner-border"></div></div></div>
    </main>
</div>

<a href="#" class="fab" id="add-patient-btn"><div class="plus-icon">+</div><div class="plus-text">Patient</div></a>

<div class="offcanvas offcanvas-bottom" tabindex="-1" id="addPatientOffcanvas" style="height: auto;">
    <div class="offcanvas-header"><h5 class="offcanvas-title w-100 text-center">Add Patient</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body">
        <form id="add-patient-form" class="mx-auto" style="max-width: 400px;">
            <div class="input-group mb-3"><span class="input-group-text"><i class="fa-solid fa-user"></i></span><input type="text" class="form-control" id="form-firstname" placeholder="First name" required></div>
            <div class="input-group mb-3"><span class="input-group-text"><i class="fa-regular fa-user"></i></span><input type="text" class="form-control" id="form-middlename" placeholder="Middle name (optional)"></div>
            <div class="input-group mb-3"><span class="input-group-text"><i class="fa-solid fa-user"></i></span><input type="text" class="form-control" id="form-lastname" placeholder="Last name" required></div>
            <div class="input-group mb-3"><span class="input-group-text"><i class="fa-solid fa-phone"></i></span><input type="text" class="form-control" id="form-phone" placeholder="Phone" required></div>
            <button type="submit" class="btn w-100" style="border: 2px solid #000; font-weight: 500;">Add Patient</button>
        </form>
    </div>
</div>

<div class="modal fade" id="resultModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border-radius: 15px;"><div class="modal-header"><h5 class="modal-title w-100 text-center">Message</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center fs-5 py-4" id="result-modal-message"></div><div class="modal-footer justify-content-center"><button type="button" class="close-btn" data-bs-dismiss="modal"><i class="fa-solid fa-xmark fs-4"></i></button></div></div></div></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        const PatientManagementApp = {
            state: {
                baseUrl: <?= json_encode($baseUrl ?? '') ?>,
                authToken: <?= json_encode($authToken ?? '') ?>,
                allPatients: [],
            },

            elements: {
                alertContainer: $('#alert-container'), patientList: $('#patient-list'),
                searchInput: $('#search-input'), searchButton: $('#search-button'),
                filterButtons: $('.filter-btn'), addPatientBtn: $('#add-patient-btn'),
                addPatientForm: $('#add-patient-form'), resultModalMessage: $('#result-modal-message'),
            },

            modals: { addPatient: null, result: null },

            init() {
                this.modals.addPatient = new bootstrap.Offcanvas(document.getElementById('addPatientOffcanvas'));
                this.modals.result = new bootstrap.Modal(document.getElementById('resultModal'));
                this.bindEvents();
                this.api.fetchPatients();
            },

            bindEvents() {
                this.elements.filterButtons.on('click', this.handlers.onFilterClick);
                const debouncedSearch = this.helpers.debounce(this.handlers.applyFilters, 300);
                this.elements.searchInput.on('keyup', debouncedSearch);
                this.elements.searchButton.on('click', this.handlers.applyFilters);
                this.elements.addPatientBtn.on('click', e => { e.preventDefault(); this.modals.addPatient.show(); });
                this.elements.addPatientForm.on('submit', this.handlers.onNewPatientSubmit);

                window.addEventListener('pageshow', e => { if (e.persisted) this.api.fetchPatients(); });
            },

            handlers: {
                applyFilters() {
                    const term = PatientManagementApp.elements.searchInput.val().toLowerCase();
                    const status = PatientManagementApp.elements.filterButtons.filter('.active').data('filter-status').toString();

                    const filtered = PatientManagementApp.state.allPatients.filter(patient => {
                        const statusMatch = (status === 'all' || patient.status.toString() === status);
                        const name = `${patient.firstname || ''} ${patient.lastname || ''}`.toLowerCase();
                        const searchMatch = !term || name.includes(term);
                        return statusMatch && searchMatch;
                    });

                    PatientManagementApp.render.patientList(filtered);
                },

                onFilterClick(e) {
                    $(e.currentTarget).addClass('active').siblings().removeClass('active');
                    PatientManagementApp.handlers.applyFilters();
                },

                onNewPatientSubmit(e) {
                    e.preventDefault();
                    const payload = {
                        firstname: $('#form-firstname').val(),
                        lastname: $('#form-lastname').val(),
                        phone: $('#form-phone').val(),
                    };
                    const middlename = $('#form-middlename').val();
                    if (middlename) payload.middlename = middlename;

                    PatientManagementApp.api.createPatient(payload);
                }
            },

            api: {
                _ajax: settings => $.ajax({ ...settings, headers: { 'Authorization': PatientManagementApp.state.authToken }, dataType: 'json' })
                    .fail(err => PatientManagementApp.helpers.showAlert(err.responseJSON?.message || 'API request failed.', 'danger')),

                fetchPatients() {
                    PatientManagementApp.elements.patientList.html('<div class="text-center p-5"><div class="spinner-border"></div></div>');
                    this._ajax({ url: `${PatientManagementApp.state.baseUrl}/patients` })
                        .done(res => {
                            PatientManagementApp.state.allPatients = res.status === 'success' ? res.data.patients : [];
                            PatientManagementApp.handlers.applyFilters();
                            if(res.status === 'success') PatientManagementApp.helpers.showAlert(`Loaded ${res.data.count} patients.`, 'success');
                        });
                },

                createPatient(payload) {
                    this._ajax({
                        url: `${PatientManagementApp.state.baseUrl}/patient/new`,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(payload),
                    }).done(() => {
                        PatientManagementApp.helpers.showResultModal('Patient added successfully!', 'success');
                        PatientManagementApp.modals.addPatient.hide();
                        PatientManagementApp.elements.addPatientForm.reset();
                        this.fetchPatients();
                    }).fail(err => PatientManagementApp.helpers.showResultModal(err.responseJSON?.message || 'Failed to add patient.', 'danger'));
                }
            },

            render: {
                patientList(patients) {
                    const listContainer = PatientManagementApp.elements.patientList;
                    if (!patients?.length) {
                        listContainer.html('<p class="text-center text-muted mt-4">No matching patients found.</p>');
                        return;
                    }
                    const itemsHTML = patients.map(p => PatientManagementApp.helpers.getPatientCardHTML(p)).join('');
                    listContainer.html(itemsHTML);
                }
            },

            helpers: {
                getPatientCardHTML(patient) {
                    const h = PatientManagementApp.helpers;
                    const fullName = `${patient.firstname || ''} ${patient.lastname || ''}`.trim() || 'Unnamed Patient';
                    const photoSrc = patient.photo ? `${PatientManagementApp.state.baseUrl}${patient.photo}` : 'https://via.placeholder.com/60';
                    const status = h.getStatusInfo(patient.status);
                    return `
                        <a href="/patient/profile/${patient.id}" class="patient-item">
                            <div class="patient-avatar"><img src="${photoSrc}" alt="Avatar"></div>
                            <div class="patient-info">
                                <div>
                                    <div class="patient-name">${fullName}</div>
                                    <div class="patient-phone">${patient.phone || 'No phone'}</div>
                                </div>
                                <div class="patient-status ${status.class}">${status.text}</div>
                            </div>
                        </a>`;
                },

                getStatusInfo: status => ({
                    '-1': { text: "Not Verified", class: "status-not-verified" },
                    '0':  { text: "Inactive", class: "status-inactive" },
                    '1':  { text: "Active", class: "status-active" },
                    '2':  { text: "Archived", class: "status-archived" },
                    '3':  { text: "Deleted", class: "status-deleted" },
                })[status] || { text: 'Unknown', class: '' },

                showAlert(message, type = 'success') {
                    const alertHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                    PatientManagementApp.elements.alertContainer.html(alertHTML).children().delay(4000).fadeOut();
                },

                showResultModal(message, type = 'success') {
                    PatientManagementApp.elements.resultModalMessage.text(message)
                        .removeClass('text-danger text-success')
                        .addClass(type === 'success' ? 'text-success' : 'text-danger');
                    PatientManagementApp.modals.result.show();
                },

                debounce(func, delay) {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                }
            }
        };

        PatientManagementApp.init();
    });
</script>
</body>
</html>